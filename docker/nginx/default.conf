# PWA-оптимизированная конфигурация для Docker контейнера
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    # Отключаем логирование для health check
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Service Worker - критически важно для PWA
    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        add_header Service-Worker-Allowed "/";
        try_files $uri =404;
    }

    # Web App Manifest - обязательно для PWA
    location = /manifest.json {
        add_header Cache-Control "public, max-age=86400"; # 1 день
        add_header Content-Type "application/manifest+json";
        try_files $uri =404;
    }

    # PWA иконки - долгосрочное кеширование
    location ~* ^/(?:pwa-|maskable-|apple-touch-)?icon.*\.(?:png|jpg|jpeg|gif|ico|svg)$ {
        add_header Cache-Control "public, max-age=31536000"; # 1 год
        expires 1y;
        try_files $uri =404;
    }

    # Статические ресурсы - агрессивное кеширование
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        add_header Cache-Control "public, max-age=31536000"; # 1 год
        expires 1y;
        
        # Добавляем CORS заголовки для шрифтов
        if ($request_filename ~* ^.*\.(woff|woff2|ttf|eot)$) {
            add_header Access-Control-Allow-Origin "*";
        }
        
        try_files $uri =404;
    }

    # HTML файлы - без кеширования для мгновенных обновлений
    location ~* \.html$ {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
        try_files $uri /index.html;
    }

    # Offline страница - для PWA fallback
    location = /offline.html {
        add_header Cache-Control "public, max-age=86400";
        internal;
    }

    # SPA маршрутизация - все неизвестные маршруты направляем в index.html
    location / {
        # Лимиты скорости для защиты от DDoS
        limit_req zone=app burst=20 nodelay;
        
        try_files $uri $uri/ /index.html;
        
        # Заголовки для SPA
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # Блокировка доступа к служебным файлам
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ^/(\.user.ini|\.htaccess|\.htpasswd|\.ssh|\.git) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Оптимизация для мобильных устройств
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        add_header Vary "Accept-Encoding";
    }

    # Предотвращение доступа к backup файлам
    location ~* \.(bak|backup|swp|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }


    # Настройки для error страниц
    error_page 404 /index.html;
    error_page 500 502 503 504 /offline.html;

    # Отключаем логирование 404 для отсутствующих favicon
    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        log_not_found off;
        access_log off;
    }
}