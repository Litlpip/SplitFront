name: 'Deploy VibeSplit PWA to Production'

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° ĞºĞ¾Ğ´Ğ°
  quality-checks:
    runs-on: ubuntu-latest
    name: 'Quality Checks'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type checking
        run: npm run type-check

      - name: Check package.json and lock file consistency
        run: npm audit --audit-level=high

      # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Ğ±Ğ¸Ğ»Ğ´Ğ°
      - name: Test build process
        run: npm run build
        env:
          VITE_API_URL: https://api.vibesplit.com

      - name: Check build artifacts
        run: |
          test -f dist/index.html || exit 1
          test -f dist/manifest.json || exit 1
          echo "âœ… Build artifacts verified"

  # Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ
  security-scan:
    runs-on: ubuntu-latest
    name: 'Security Scan'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Ğ‘Ğ¸Ğ»Ğ´ Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹
  build-and-deploy:
    needs: [quality-checks, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build PWA application
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_ANALYTICS_KEY: ${{ secrets.VITE_ANALYTICS_KEY }}
          NODE_ENV: production

      - name: Verify PWA build
        run: |
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          test -f dist/index.html || { echo "âŒ index.html not found"; exit 1; }
          test -f dist/manifest.json || { echo "âŒ manifest.json not found"; exit 1; }

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ bundle
          BUNDLE_SIZE=$(du -s dist/ | cut -f1)
          if [ $BUNDLE_SIZE -gt 51200 ]; then  # 50MB Ğ»Ğ¸Ğ¼Ğ¸Ñ‚
            echo "âš ï¸ Bundle size too large: ${BUNDLE_SIZE}KB"
            exit 1
          fi

          echo "âœ… PWA build verified successfully"
          echo "ğŸ“¦ Bundle size: ${BUNDLE_SIZE}KB"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° VPS
      - name: Deploy to Production VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 300s
          script: |
            # Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²
            RED='\033[0;31m'
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            NC='\033[0m' # No Color

            echo -e "${YELLOW}ğŸš€ Starting deployment...${NC}"

            # Ğ›Ğ¾Ğ³Ğ¸Ğ½Ğ¸Ğ¼ÑÑ Ğ² Container Registry
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ·
            NEW_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
            echo -e "${YELLOW}ğŸ“¦ Pulling new image: $NEW_IMAGE${NC}"
            docker pull $NEW_IMAGE

            # Blue-Green deployment ÑÑ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ
            CURRENT_CONTAINER=$(docker ps --filter "name=vibesplit-pwa" --format "{{.Names}}" | head -n1)

            if [ ! -z "$CURRENT_CONTAINER" ]; then
              echo -e "${YELLOW}ğŸ”„ Found running container: $CURRENT_CONTAINER${NC}"
              NEW_CONTAINER="vibesplit-pwa-new"
            else
              NEW_CONTAINER="vibesplit-pwa"
            fi

            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
            echo -e "${YELLOW}ğŸš€ Starting new container: $NEW_CONTAINER${NC}"
            docker run -d \
              --name $NEW_CONTAINER \
              --restart unless-stopped \
              -p 8080:80 \
              -v /var/log/vibesplit:/var/log/nginx \
              -e NODE_ENV=production \
              --health-cmd="curl -f http://localhost:80/health || exit 1" \
              --health-interval=30s \
              --health-timeout=10s \
              --health-retries=3 \
              $NEW_IMAGE

            # Ğ–Ğ´ĞµĞ¼ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            echo -e "${YELLOW}â³ Waiting for container to be ready...${NC}"
            sleep 30

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ health check
            for i in {1..10}; do
              if docker exec $NEW_CONTAINER curl -f http://localhost:80/health > /dev/null 2>&1; then
                echo -e "${GREEN}âœ… Health check passed${NC}"
                break
              fi
              if [ $i -eq 10 ]; then
                echo -e "${RED}âŒ Health check failed after 10 attempts${NC}"
                docker logs $NEW_CONTAINER
                docker stop $NEW_CONTAINER
                docker rm $NEW_CONTAINER
                exit 1
              fi
              echo -e "${YELLOW}â³ Health check attempt $i/10...${NC}"
              sleep 10
            done

            # ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ñ‚Ñ€Ğ°Ñ„Ğ¸Ğº (ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€)
            if [ ! -z "$CURRENT_CONTAINER" ] && [ "$CURRENT_CONTAINER" != "$NEW_CONTAINER" ]; then
              echo -e "${YELLOW}ğŸ”„ Switching traffic to new container${NC}"
              
              # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              docker stop $CURRENT_CONTAINER
              docker rm $CURRENT_CONTAINER
              
              # ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
              docker rename $NEW_CONTAINER vibesplit-pwa
            fi

            # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹
            echo -e "${YELLOW}ğŸ§¹ Cleaning up old images${NC}"
            docker image prune -f

            # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Nginx Ğ½Ğ° Ñ…Ğ¾ÑÑ‚Ğµ (ĞµÑĞ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½)
            if systemctl is-active --quiet nginx; then
              echo -e "${YELLOW}ğŸ”„ Reloading Nginx${NC}"
              sudo nginx -t && sudo systemctl reload nginx
            fi

            echo -e "${GREEN}ğŸ‰ Deployment completed successfully!${NC}"

      # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
      - name: Post-deployment verification
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
            echo "ğŸ” Verifying application accessibility..."

            # Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Local health check passed"
            else
              echo "âŒ Local health check failed"
              exit 1
            fi

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ PWA Ñ€ĞµÑÑƒÑ€ÑÑ‹
            if curl -f http://localhost:8080/manifest.json > /dev/null 2>&1; then
              echo "âœ… PWA manifest accessible"
            else
              echo "âŒ PWA manifest not accessible"
            fi

            if curl -f http://localhost:8080/sw.js > /dev/null 2>&1; then
              echo "âœ… Service Worker accessible"
            else
              echo "âš ï¸ Service Worker not accessible"
            fi

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
            echo "ğŸ“Š Container statistics:"
            docker stats vibesplit-pwa --no-stream --format "table {{.Name}}\\t{{.CPUPerc}}\\t{{.MemUsage}}"

      # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            VibeSplit PWA Deployment Status: ${{ job.status }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # Smoke tests Ğ¿Ğ¾ÑĞ»Ğµ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
  smoke-tests:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Run smoke tests
        run: |
          # ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ smoke tests Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ³Ğ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»Ğ°
          echo "ğŸ§ª Running smoke tests..."

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ³Ğ»Ğ°Ğ²Ğ½ÑƒÑ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
          if curl -f https://vibesplit.com/ > /dev/null 2>&1; then
            echo "âœ… Main page accessible"
          else
            echo "âŒ Main page not accessible"
            exit 1
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ PWA Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚
          if curl -f https://vibesplit.com/manifest.json > /dev/null 2>&1; then
            echo "âœ… PWA manifest accessible"
          else
            echo "âŒ PWA manifest not accessible"
            exit 1
          fi

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Service Worker
          if curl -f https://vibesplit.com/sw.js > /dev/null 2>&1; then
            echo "âœ… Service Worker accessible"
          else
            echo "âš ï¸ Service Worker not accessible"
          fi

          echo "ğŸ‰ Smoke tests completed successfully!"
